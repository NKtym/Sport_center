{
  "id": null,
  "uid": "basic-postgres",
  "title": "PG monitoring",
  "tags": ["postgres","monitoring"],
  "timezone": "browser",
  "schemaVersion": 30,
  "version": 2,
  "panels": [
    {
      "type": "timeseries",
      "title": "Transactions/sec",
      "gridPos": {"x":0,"y":0,"w":12,"h":5},
      "id": 1,
      "targets": [
        {
          "expr": "rate(pg_stat_database_xact_commit{datname=\"appdb\"}[5m]) + rate(pg_stat_database_xact_rollback{datname=\"appdb\"}[5m])",
          "refId": "A"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Active connections",
      "gridPos": {"x":12,"y":0,"w":6,"h":4},
      "id": 2,
      "targets": [
        {
          "expr": "sum(pg_stat_activity_count{datname=\"appdb\", state=\"active\"})",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Deadlocks",
      "gridPos": {"x":0,"y":6,"w":12,"h":5},
      "id": 3,
      "targets": [
        {
          "expr": "increase(pg_stat_database_deadlocks{datname=\"appdb\"}[3m])",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Buffer hit(%)",
      "gridPos": {"x":12,"y":4,"w":10,"h":6},
      "id": 4,
      "targets": [
        {
          "expr": "(sum(pg_stat_database_blks_hit{datname=\"appdb\"}) / (sum(pg_stat_database_blks_hit{datname=\"appdb\"}) + sum(pg_stat_database_blks_read{datname=\"appdb\"}))) * 100",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Container network resive (bytes/sec)",
      "gridPos": {"x":0,"y":10,"w":8,"h":10},
      "id": 5,
      "targets": [
        {
          "expr": "sum by(name) (rate(container_network_receive_bytes_total{name=~\"(?i).*db.*|.*postgres.*|.*bdprod-db-1.*\"}[2m]))",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Container network send (bytes/sec)",
      "gridPos": {"x":8,"y":10,"w":8,"h":10},
      "id": 6,
      "targets": [
        {
          "expr": "sum by(name) (rate(container_network_transmit_bytes_total{name=~\"(?i).*db.*|.*postgres.*|.*bdprod-db-1.*\"}[2m]))",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Container CPU usage",
      "gridPos": {"x":0,"y":15,"w":8,"h":8},
      "id": 7,
      "targets": [
        {
          "expr": "sum by(name) (rate(container_cpu_usage_seconds_total{name=~\"(?i).*db.*|.*postgres.*|.*bdprod-db-1.*\"}[5m]))",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Host CPU %",
      "gridPos": {"x":8,"y":15,"w":8,"h":6},
      "id": 8,
      "targets": [
        {
          "expr": "100 * (1 - avg by(instance) (rate(node_cpu_seconds_total{mode=\"idle\"}[5m])))",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Container memory usage(bytes)",
      "gridPos": {"x":0,"y":20,"w":8,"h":8},
      "id": 9,
      "targets": [
        {
          "expr": "container_memory_usage_bytes{name=~\"(?i).*db.*|.*postgres.*|.*bdprod-db-1.*\"}",
          "refId": "A"
        },
        {
          "expr": "container_memory_limit_bytes{name=~\"(?i).*db.*|.*postgres.*|.*bdprod-db-1.*\"}",
          "refId": "B"
        }
      ]
    },
    {
      "type": "stat",
      "title": "OS Memory used %",
      "gridPos": {"x":8,"y":20,"w":4,"h":3},
      "id": 10,
      "targets": [
        {
          "expr": "(1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100",
          "refId": "A"
        }
      ]
    },
    {
      "type": "stat",
      "title": "OS Cache+Buffers % of RAM",
      "gridPos": {"x":12,"y":20,"w":4,"h":3},
      "id": 11,
      "targets": [
        {
          "expr": "(node_memory_Cached_bytes + node_memory_Buffers_bytes) / node_memory_MemTotal_bytes * 100",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Container FS usage (bytes)",
      "gridPos": {"x":8,"y":23,"w":8,"h":10},
      "id": 12,
      "targets": [
        {
          "expr": "container_fs_usage_bytes{name=~\"(?i).*db.*|.*postgres.*|.*bdprod-db-1.*\"}",
          "refId": "A"
        },
        {
          "expr": "container_fs_limit_bytes{name=~\"(?i).*db.*|.*postgres.*|.*bdprod-db-1.*\"}",
          "refId": "B"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Disk utilization %",
      "gridPos": {"x":0,"y":25,"w":8,"h":8},
      "id": 13,
      "targets": [
        {
          "expr": "(node_filesystem_size_bytes{fstype!~\"tmpfs|squashfs\"} - node_filesystem_avail_bytes{fstype!~\"tmpfs|squashfs\"}) / node_filesystem_size_bytes{fstype!~\"tmpfs|squashfs\"} * 100",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Long transactions max duration (sec)",
      "gridPos": {"x":8,"y":28,"w":8,"h":8},
      "id": 14,
      "targets": [
        {
          "expr": "max_over_time(pg_stat_activity_max_tx_duration{datname=\"appdb\"}[5m])",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Connections: total / active",
      "gridPos": {"x":0,"y":30,"w":8,"h":8},
      "id": 15,
      "targets": [
        {
          "expr": "sum(pg_stat_database_numbackends{datname=\"appdb\"})",
          "refId": "A",
          "legendFormat": "total"
        },
        {
          "expr": "sum(pg_stat_activity_count{datname=\"appdb\", state=\"active\"})",
          "refId": "B",
          "legendFormat": "active"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Buffer hit %",
      "gridPos": {"x":16,"y":6,"w":6,"h":4},
      "id": 17,
      "targets": [
        {
          "expr": "(sum(pg_stat_database_blks_hit{datname=\"appdb\"}) / (sum(pg_stat_database_blks_hit{datname=\"appdb\"}) + sum(pg_stat_database_blks_read{datname=\"appdb\"}))) * 100",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Container network per interface",
      "gridPos": {"x":8,"y":35,"w":10,"h":14},
      "id": 18,
      "targets": [
        {
          "expr": "sum by(name,interface) (rate(container_network_receive_bytes_total{name=~\"(?i).*db.*|.*postgres.*|.*bdprod-db-1.*\"}[2m]))",
          "refId": "A"
        },
        {
          "expr": "sum by(name,interface) (rate(container_network_transmit_bytes_total{name=~\"(?i).*db.*|.*postgres.*|.*bdprod-db-1.*\"}[2m]))",
          "refId": "B"
        }
      ]
    }
  ],
  "time": { "from": "now-24h", "to": "now" },
  "refresh": "30s"
}
